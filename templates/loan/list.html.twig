{% extends 'base.html.twig' %}

{% block title %}{{ parent() }} | Liste des emprunts{% endblock %}

{% block body %}
    {{ parent() }}
    <br>
    <a href="{{ path('loan_add') }}" title="ajouter un site">Faire une demande d'emprunts</a>
    <table id="table" 
        class="table table-hover" 
        data-toggle="table" 
        data-filter-control="true">
        <thead>
            <tr>
            <th data-field="driver_id" data-filter-control="select">Conducteur</th>
            <th data-field="depart_address" data-filter-control="select">Addresse de depart</th>
            <th data-field="destinationAddress" data-filter-control="select">Addresse de destination</th>
            <th data-field="departDate" data-filter-control="select">Date de départ</th>
            <th data-field="returnDate" data-filter-control="select">Date d'arrivée</th>
            <th date-field="affectedVehicle" data-filter-control="select">Voiture</th>
            {% if is_granted('ROLE_GESTIONNAIRE') %}
            <th date-field="affected_return_vehicle" data-filter-control="select">Voiture rendue</th>
            <th date-field="affected_return_key" data-filter-control="select">Clé rendue</th>
            {% endif %}
            <th date-field="statut" data-filter-control="select">Statut</th>
            <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for loan in loans %}
            <tr>
            <td>{{ loan.driver.firstName }} {{ loan.driver.lastName }}</td>
            <td>{{ loan.affectedVehicle.idSite.address }} - {{ loan.affectedVehicle.idSite.city }} - {{ loan.affectedVehicle.idSite.cp }}</td>
            <td>{{ loan.destinationAddress }} - {{ loan.destinationCity }} - {{ loan.destinationCp }}</td>
            <td>{{ loan.departDate|date("d/m/Y") }}</td>
            <td>{{ loan.returnDate|date("d/m/Y") }}</td>
            <td>{{ loan.affectedVehicle.brand }} - {{ loan.affectedVehicle.model }}</td>
            {% if is_granted('ROLE_GESTIONNAIRE') %}
            <td>{% if loan.returnVehicle %}<i class="bi bi-check-lg"></i>{% else %}<i class="bi bi-x-lg"></i>{% endif %}</td>
            <td>{% if loan.returnKey %}<i class="bi bi-check-lg"></i>{% else %}<i class="bi bi-x-lg"></i>{% endif %}</td>
            {% endif %}
            <td>{{ loan.statut }}</td>
            <td>
            {% if loan.statut == "En validation" %}
              {% if is_granted('ROLE_GESTIONNAIRE') %}
                <a class="btn btn-success" href="{{ path('loan_valider',{'id':loan.id}) }}">Valider</a><a class="btn btn-danger" href="{{ path('loan_refuser',{'id':loan.id}) }}">Refuser</a>
                {% if loan.driver.id == app.user.id %}
                <a class="btn btn-danger" href="{{ path('loan_annuler',{'id':loan.id}) }}">Annuler</a>
                {% endif %}
              {% else %}
              {% endif %}
            {% elseif loan.statut == 'Validé' %}
              {% if loan.driver.id == app.user.id %}
                <a class="btn btn-danger" href="{{ path('loan_annuler',{'id':loan.id}) }}">Annuler</a><a class="btn btn-success" href="{{ path('loan_complete',{'id':loan.id}) }}">Terminer l'emprunt</a>
              {% else %}
                <a class="btn btn-primary" href="">Rejoindre ce trajet</a>
              {% endif %}
            {% elseif loan.statut == 'Complété' %}
              {% if is_granted('ROLE_GESTIONNAIRE') %}
                {% if not loan.returnVehicle %}
                  <a class="btn btn-primary" href="{{ path('loan_rendreV',{'id':loan.id}) }}">Voiture rendu</a>
                {% endif %}
                {% if not loan.returnKey %}
                  <a class="btn btn-primary" href="{{ path('loan_rendreC',{'id':loan.id}) }}">Clé rendu</a>
                {% endif %}
              {% endif %}
            {% endif %}
            </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}
{% block javascripts %}{{ parent() }} 
<link href="https://unpkg.com/bootstrap-table@1.21.0/dist/bootstrap-table.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.0/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.21.0/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>
<script>
var $table = $('#table');
$(function() {
    $('#table').bootstrapTable()
  })
</script>
{% endblock %}